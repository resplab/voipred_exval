# title: "EVPI for external validation"
# author: "Mohsen Sadatsafavi"
# date: "2023.01.10"


source('core.R')

library(voipred)
library(sqldf)
set.seed(123) #123 #3344 #123456

settings <- list(
  val_sample_size = 500,
  n_sim=1000,
  Bayesian_bootstrap=T,
  z=0.02
)

data(gusto)
gusto$kill <- (as.numeric(gusto$Killip)>1)*1
gusto$Y <- gusto$day30

tmp <- sqldf("SELECT regl, COUNT(*) AS N, AVG(Y) AS mean_Y FROM gusto GROUP BY regl ORDER BY mean_Y")
high_reg <- tmp$regl[9:16]

data_us <- gusto[gusto$regl %in% c(1, 7, 9, 10, 11, 12, 14, 15),]
data_other <- gusto[!gusto$regl %in% c(1, 7, 9, 10, 11, 12, 14, 15),]

# data_us <- gusto[gusto$regl %in% high_reg,]
# data_other <- gusto[!gusto$regl %in% high_reg,]
# y1 <- sum(data_us$Y)
# y2 <- sum(data_other$Y)
# data_us <- data_us[1:min(which(cumsum(data_us$Y)==y2)),]

n_us <- dim(data_us)[1]
n_other <- dim(data_other)[1]

out <- data.frame()
for(i in 1:settings$n_sim)
{
  conscripts_us <- sample(1:n_us, size=500)
  conscripts_other <- c() #sample(1:n_other, size=500)
  val_data_us <- data_us[conscripts_us,]
  val_data_other <- data_other[conscripts_other,]
  
  dev_data_us <- data_us[-conscripts_us,]
  dev_data_other <- data_other#[-conscripts_other,]
  
  model_us <- glm(Y ~ age + miloc + pmi + kill + pmin(sysbp,100) + pulse, data=dev_data_us, family=binomial(link="logit"))
  model_other <- glm(Y ~ age + miloc + pmi + kill + pmin(sysbp,100) + pulse, data=dev_data_other, family=binomial(link="logit"))
  
  pi_us_us <- predict(model_us, type="response", newdata=val_data_us)
  pi_us_other <- predict(model_other, type="response", newdata=val_data_us)
  # pi_other_us <- predict(model_us, type="response", newdata=val_data_other)
  # pi_other_other <- predict(model_other, type="response", newdata=val_data_other)
  #
  # NB_model_us_us[i] <- mean((val_data_us$pi_us>z)*(val_data_us$Y - (1-val_data_us$Y)*z/(1-z)))
  # NB_model_us_other[i] <- mean((val_data_us$pi_other>z)*(val_data_us$Y - (1-val_data_us$Y)*z/(1-z)))
  # NB_model_other_us[i] <- mean((val_data_other$pi_us>z)*(val_data_other$Y - (1-val_data_other$Y)*z/(1-z)))
  # NB_model_other_other[i] <- mean((val_data_other$pi_other>z)*(val_data_other$Y - (1-val_data_other$Y)*z/(1-z)))
  # 
  # NB_all_us[i] <- mean((val_data_us$Y - (1-val_data_us$Y)*z/(1-z)))
  # NB_all_other[i] <- mean((val_data_other$Y - (1-val_data_other$Y)*z/(1-z)))
  #
  
  dt_us_us <- cbind(val_data_us, pi=pi_us_us)
  dt_us_other <- cbind(val_data_us, pi=pi_us_other)
  # dt_other_us <- cbind(val_data_other, pi=pi_other_us)
  # dt_other_other <- cbind(val_data_other, pi=pi_other_other)

  out <- data.frame(rbind(out,
    cbind(scenario="res_us_us", voi_ex_glm(model_us,dt_us_us,method='bootstrap',Bayesian_bootstrap = T,z = settings$z, n_sim=1000)),
    cbind(scenario="res_us_other", voi_ex_glm(model_other,dt_us_other,method='bootstrap',Bayesian_bootstrap = T,z = settings$z, n_sim=1000))
    #,
    #cbind(scenario="res_other_us", voi_ex_glm(model_us,dt_other_us,method='bootstrap',Bayesian_bootstrap = T,z = settings$z, n_sim=1000)),
    #cbind(scenario="res_other_other", voi_ex_glm(model_other,dt_other_other,method='bootstrap',Bayesian_bootstrap = T,z = settings$z, n_sim=1000))
  ))
  
  if(is.null(sum(out$EVPIv))) browser()
  
  cat('.')
}



#out %>% group_by(scenario) %>% summarise(n=n(), EVPI=mean(EVPIv), p_useful=mean(p_useful))


res <- sqldf("SELECT scenario, 
      COUNT(*) AS n, 
      AVG(ENB_model-ENB_all) AS dNB,
      SQRT(VARIANCE(ENB_model-ENB_all)/COUNT(*)) AS se_dNB, 
      AVG(EVPIv) AS EVPI, 
      SQRT(VARIANCE(EVPIv)/COUNT(*)) AS se_EVPI, 
      AVG(p_useful) AS p_useful, 
      SQRT(VARIANCE(p_useful)/COUNT(*)) AS se_p_useful
      FROM out GROUP BY scenario")


